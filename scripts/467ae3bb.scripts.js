var CONFIG={firebase:"https://dide.firebaseio.com",devices:[{id:1,category:"iPad",name:"iPad 2 iOS6",device:"HMHHKHHMHHKH37"},{id:2,category:"iPad",name:"iPad 3 iOS5",device:"HMHHKHHMHHKH39"},{id:3,category:"iPad",name:"iPad 3 iOS6",device:"HMHHKHHMHHKH45"},{id:4,category:"Android",name:"Samsung Android 4.1+",device:"HMHHKHHMHHKH53"},{id:5,category:"Android",name:"Samsung Nexus 3.2",device:"HMHHKHHMHHKH54"}],demo:!0},FiltersModule=angular.module("App.filters",[]),App=angular.module("apparatusApp",["firebase","timer","ngCookies","App.filters"]);App.constant("CONFIG",CONFIG),App.config(["$routeProvider",function(a){a.when("/main",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/",{templateUrl:"views/registration.html",controller:"RegistrationCtrl"}).when("/profile",{templateUrl:"views/profile.html",controller:"ProfileCtrl",resolve:{validate:function(a,b){var c=a.defer();return CONFIG.demo&&b.path("/main"),c.resolve(),c.promise}}}).otherwise({redirectTo:"/"})}]),App.run(["$rootScope","$timeout","$cookies","$location","Auth",function(a,b,c,d,e){a.$on("auth:logout",function(){b(function(){delete c.user,d.path("/")})}),a.$on("$routeChangeStart",function(){e.init(),a.cookies=c}),a.logout=function(){e.sally.logout()}}]),App.factory("Auth",["CONFIG","$rootScope",function(a,b){return{sally:null,init:function(){this.sally=new FirebaseSimpleLogin(new Firebase(a.firebase),function(a,c){a?b.$broadcast("auth:fail",{error:a}):c?b.$broadcast("auth:login",{user:c}):b.$broadcast("auth:logout",{})})}}}]),App.controller("MainCtrl",["$scope","$timeout","$cookies","angularFireCollection","$filter","CONFIG",function(a,b,c,d,e,f){a.user=c.user,a.holders=d(new Firebase(f.firebase+"/holders"),function(){b(function(){a.devices=f.devices,a.devices.forEach(function(b,c){a.devices[c].hold=a.isHeld(b.id,a.user)?"me":a.isHeld(b.id)?"you":"none"}),a.categories=_.map(_.groupBy(a.devices,function(a){return a.category}),function(a,b){return b}),a.filters=[]})}),a.buy=function(b,c){var d=e("holderByDeviceId")(a.holders,b);d&&d.user===a.user?a.holders.update({$ref:d.$ref,user:a.user,deviceId:b,timespan:e("timespan")(c),startAt:(new Date).getTime()}):a.isHeld(b)||(a.holders.add({user:a.user,deviceId:b,timespan:e("timespan")(c),startAt:(new Date).getTime()}),_.each(a.devices,function(c,d){c.id===b&&(a.devices[d].hold="me")}))},a.sell=function(b){var c=e("holderByDeviceId")(a.holders,b);c&&c.user!==a.user||(a.holders.remove({$ref:c.$ref}),_.each(a.devices,function(c,d){c.id===b&&(a.devices[d].hold="none")}))},a.isHeld=function(b,c){return e("devicesInUse")(a.holders,b,c)},a.isDeviceAvailable=function(){return _.filter(a.devices,function(a){return"you"!==a.hold}).length>0},a.isDeviceInUse=function(){return _.filter(a.holders,function(b){return!a.isHeld(b.deviceId,a.user)}).length>0},a.filterIt=function(b){var c=_.indexOf(a.filters,b);-1!==c?a.filters.splice(c,1):a.filters.push(b)},a.$watch("holders.length",function(b){b&&a.devices&&a.devices.forEach(function(b,c){a.devices[c].hold=a.isHeld(b.id,a.user)?"me":a.isHeld(b.id)?"you":"none"})})}]),App.controller("RegistrationCtrl",["$scope","$timeout","$cookies","$location","Auth","CONFIG",function(a,b,c,d,e,f){a.CONFIG=f,a.$on("auth:login",function(e,f){b(function(){a.error_code="",a.isRegistered=!1,c.user=f.user.email,d.path("/main")})}),a.$on("auth:fail",function(c,d){b(function(){a.error_code=d.error.code})}),a.loginMe=function(a,b){e.sally.login("password",{email:a,password:b})},a.registerMe=function(c,d){e.sally.createUser(c,d,function(c){b(function(){c?a.$broadcast("auth:fail",{error:c}):(a.email=a.password="",a.isRegistered=!0)})})}}]),App.controller("ProfileCtrl",["$scope","$timeout","Auth",function(a,b,c){a.changePassword=function(){c.sally.changePassword(a.change.email,a.change.current_password,a.change.new_password,function(d){b(function(){d?a.error_code=d.code:c.sally.logout()})})}}]),FiltersModule.filter("deviceNameById",function(){return function(a,b){return a&&a.filter(function(a){return a.id===b})[0].name}}),FiltersModule.filter("deviceByCategory",function(){return function(a,b){var c=[];return a&&b&&b.length>0?a.forEach(function(a){-1!==_.indexOf(b,a.category)&&c.push(a)}):c=a,c}}),FiltersModule.filter("timespan",function(){return function(a,b){var c;if(b)switch(a){case 30:c="30 Minutes";break;case 60:c="1 Hour";break;case 120:c="2 Hours";break;case 180:c="3 Hours";break;case 240:c="4 Hours";break;case 480:c="Whole Day";break;case 960:c="2 Days";break;case 999999999999:c="Forever";break;default:c="30 Minutes"}else switch(a){case"30 Minutes":c=30;break;case"1 Hour":c=60;break;case"2 Hours":c=120;break;case"3 Hours":c=180;break;case"4 Hours":c=240;break;case"Whole Day":c=480;break;case"2 Days":c=960;break;case"Forever":c=999999999999;break;default:c=30}return c}}),FiltersModule.filter("holderByDeviceId",function(){return function(a,b){return _.findWhere(a,{deviceId:b})}}),FiltersModule.filter("devicesInUse",function(){return function(a,b,c){return angular.isDefined(c)?angular.isDefined(_.findWhere(a,{user:c,deviceId:b})):angular.isDefined(_.findWhere(a,{deviceId:b}))}});